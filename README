================================================================================
                        VDR CECRemote Plugin
================================================================================

A plugin for the Video Disk Recorder (VDR) that enables HDMI-CEC control.
Control your TV, AV receiver, and other CEC-enabled devices directly from VDR,
and use your TV remote to control VDR.

Originally written by: Ulrich Eckhardt <uli-vdr@uli-eckhardt.de>

License: GNU General Public License v2 or later (see COPYING)

================================================================================
                           TABLE OF CONTENTS
================================================================================

  1. Features
  2. Requirements
  3. Installation
     3.1 Ubuntu/Debian
     3.2 Building from Source
  4. Quick Start
  5. Configuration Reference
     5.1 Global Options
     5.2 Device Definitions
     5.3 Key Mappings
     5.4 Menu Definitions
     5.5 CEC Command Handlers
     5.6 Command Lists
  6. SVDRP Commands
  7. Command Line Arguments
  8. Troubleshooting
  9. Examples

================================================================================
                              1. FEATURES
================================================================================

  * Receive remote control commands from your TV via HDMI-CEC
  * Send CEC commands to control TVs, receivers, and players
  * Automatic power on/off synchronization with your TV
  * Customizable key mappings (CEC <-> VDR)
  * Execute shell scripts on CEC events
  * Still picture player for device control screens
  * Manual vs. timed start detection (RTC support)
  * Volume forwarding to audio devices

================================================================================
                            2. REQUIREMENTS
================================================================================

  * VDR >= 2.0.0
  * libCEC >= 4.0.0    - http://libcec.pulse-eight.com/
  * PugiXML >= 1.5     - http://pugixml.org/
  * A CEC-compatible USB adapter (e.g., Pulse-Eight) or built-in CEC
    (Raspberry Pi, some graphics cards)

  For PugiXML on Raspberry Pi see:
  http://distribution-us.hexxeh.net/raspbian/archive/raspbian/pool/main/p/pugixml/

================================================================================
                            3. INSTALLATION
================================================================================

3.1 Ubuntu/Debian
-----------------

Install the required development packages:

    sudo apt-get install libcec-dev libp8-platform-dev libpugixml-dev vdr-dev

This installs:
  - libcec-dev: libCEC development files for HDMI-CEC communication
  - libp8-platform-dev: Platform support library required by libCEC
  - libpugixml-dev: PugiXML development files for XML parsing
  - vdr-dev: VDR development headers

Optional - Install CEC utilities for testing:

    sudo apt-get install cec-utils

3.2 Building from Source
------------------------

    make
    sudo make install

The plugin will be installed to VDR's plugin directory.

================================================================================
                            4. QUICK START
================================================================================

1. SCAN FOR CEC DEVICES

   Before configuring the plugin, scan your CEC bus to find devices:

       echo "scan" | cec-client -s -d 1

   Example output:

       opening a connection to the CEC adapter...
       requesting CEC bus information ...
       CEC bus information
       ===================
       device #0: TV
       address:       0.0.0.0
       active source: no
       vendor:        LG
       osd string:    TV
       CEC version:   1.4
       power status:  on
       language:      ger

       device #4: Playback 1
       address:       2.0.0.0
       active source: no
       vendor:        Pulse Eight
       osd string:    CECTester
       CEC version:   1.4
       power status:  on
       language:      ???

   Or with the plugin already running:

       svdrpsend plug cecremote LSTD

2. CREATE CONFIGURATION FILE

   Copy the example configuration:

       mkdir -p /etc/vdr/plugins/cecremote
       cp contrib/cecremote.xml /etc/vdr/plugins/cecremote/

   Edit the file to match your device setup.

3. PREVENT DEVICE CONFLICTS

   Install the udev rule to prevent ModemManager from grabbing the adapter:

       sudo cp contrib/20-libcec.rules /etc/udev/rules.d/
       sudo udevadm control --reload-rules

4. START VDR

   Start VDR with the plugin:

       vdr -P cecremote

================================================================================
                       5. CONFIGURATION REFERENCE
================================================================================

The configuration file uses XML format. Root element is <config>.

    <?xml version="1.0" encoding="UTF-8"?>
    <config>
        <global>...</global>
        <device>...</device>
        <ceckeymap>...</ceckeymap>
        <vdrkeymap>...</vdrkeymap>
        <globalkeymap>...</globalkeymap>
        <menu>...</menu>
        <onceccommand>...</onceccommand>
    </config>

-------------------------------------------------------------------------------
5.1 Global Options
-------------------------------------------------------------------------------

    <global>
        <cecdebug>7</cecdebug>
        <hdmiport>1</hdmiport>
        <basedevice>0</basedevice>
        <rtcdetect>true</rtcdetect>
        <shutdownonstandby>false</shutdownonstandby>
        <poweroffonstandby>false</poweroffonstandby>
        <startupdelay>0</startupdelay>
        <physical>1000</physical>
        <cecdevicetype>RECORDING_DEVICE</cecdevicetype>
        <audiodevice>TV</audiodevice>
        <keymaps cec="default" vdr="default" globalvdr="default"/>
        <onstart>...</onstart>
        <onmanualstart>...</onmanualstart>
        <onstop>...</onstop>
        <onswitchtotv>...</onswitchtotv>
        <onswitchtoradio>...</onswitchtoradio>
        <onswitchtoreplay>...</onswitchtoreplay>
        <onvolumeup>...</onvolumeup>
        <onvolumedown>...</onvolumedown>
    </global>

OPTIONS:

  <cecdebug>          CEC library debug level (see cec_log_level in cectypes.h)
                      1=errors, 2=warnings, 4=notice, 8=traffic, 16=debug
                      Combine with OR, e.g., 7 = errors+warnings+notice

  <hdmiport>          HDMI port number where the adapter is connected (1-15)

  <basedevice>        Logical address of device adapter connects to (0=TV)

  <rtcdetect>         Use RTC to detect manual vs. timed start (true/false)

  <shutdownonstandby> Set devices to standby on VDR shutdown (true/false)

  <poweroffonstandby> Power off devices on VDR shutdown (true/false)

  <startupdelay>      Seconds to wait before CEC initialization

  <physical>          Physical address override (hex, e.g., 1000 = 1.0.0.0)

  <cecdevicetype>     Device type to register: RECORDING_DEVICE, TUNER, TV,
                      PLAYBACK_DEVICE, AUDIO_SYSTEM

  <audiodevice>       Device for volume key forwarding

  <keymaps>           Default keymaps (cec, vdr, globalvdr attributes)

  <onstart>           Commands executed on plugin start
  <onmanualstart>     Commands executed only on manual start (not timer)
  <onstop>            Commands executed on plugin shutdown
  <onswitchtotv>      Commands executed when switching to TV channel
  <onswitchtoradio>   Commands executed when switching to radio channel
  <onswitchtoreplay>  Commands executed when starting replay
  <onvolumeup>        Commands executed on volume increase
  <onvolumedown>      Commands executed on volume decrease

NOTE: Raspberry Pi libCEC may crash when registering multiple device types.

-------------------------------------------------------------------------------
5.2 Device Definitions
-------------------------------------------------------------------------------

Define CEC devices by physical and/or logical address:

    <device id="blueray">
        <physical>2000</physical>
        <logical>8</logical>
    </device>

  <physical>  Physical address in hex (2000 = HDMI port 2 on TV)
  <logical>   Logical address fallback (0-15)

The plugin tries physical address first, then falls back to logical.
Device IDs can be referenced elsewhere (e.g., in command lists).

Predefined device: "TV" (logical address 0)

-------------------------------------------------------------------------------
5.3 Key Mappings
-------------------------------------------------------------------------------

Three types of keymaps:

  <ceckeymap>     CEC key -> VDR key(s)  (incoming remote commands)
  <vdrkeymap>     VDR key -> CEC key(s)  (outgoing commands in player)
  <globalkeymap>  VDR key -> CEC key(s)  (outgoing commands globally)

EXAMPLE - Remap SELECT to Menu:

    <ceckeymap id="mymap">
        <key code="SELECT">
            <value>Menu</value>
        </key>
        <key code="RIGHT_UP">
            <value>Right</value>  <!-- Only Right, not Right+Up -->
        </key>
    </ceckeymap>

EXAMPLE - Remap OK to ROOT_MENU:

    <vdrkeymap id="tvcontrol">
        <key code="Ok">
            <value>ROOT_MENU</value>
        </key>
    </vdrkeymap>

Use SVDRP to list available key codes:

    svdrpsend plug cecremote LSTK    # List CEC key codes

-------------------------------------------------------------------------------
5.4 Menu Definitions
-------------------------------------------------------------------------------

Create OSD menu entries for controlling devices:

    <menu name="Blu-Ray Player" address="blueray">
        <onstart>
            <poweron>blueray</poweron>
            <makeactive/>
        </onstart>
        <onstop>
            <makeinactive/>
        </onstop>
    </menu>

POWER TOGGLE MODE (alternative to onstart/onstop):

    <menu name="TV Power" address="TV">
        <onpoweron>
            <poweroff>TV</poweroff>
        </onpoweron>
        <onpoweroff>
            <poweron>TV</poweron>
            <makeactive/>
        </onpoweroff>
    </menu>

WITH STILL PICTURE PLAYER:

    <menu name="Blu-Ray" address="blueray">
        <player file="/path/to/blueray.mpg">
            <stop>Back</stop>
            <stop>Menu</stop>
            <keymaps cec="default" vdr="blueray"/>
            <onkey code="Red">
                <exec>/usr/local/bin/blueray-eject.sh</exec>
            </onkey>
            <onvolumeup>...</onvolumeup>
            <onvolumedown>...</onvolumedown>
        </player>
        <onstart>
            <poweron>blueray</poweron>
        </onstart>
        <onstop>
            <poweroff>blueray</poweroff>
        </onstop>
    </menu>

-------------------------------------------------------------------------------
5.5 CEC Command Handlers
-------------------------------------------------------------------------------

React to CEC commands from other devices:

    <onceccommand command="STANDBY" initiator="TV">
        <commandlist>
            <exec>/usr/local/bin/vdr-shutdown.sh</exec>
        </commandlist>
    </onceccommand>

    <onceccommand command="SET_STREAM_PATH" initiator="TV">
        <execmenu>Blu-Ray Player</execmenu>
    </onceccommand>

ATTRIBUTES:
  command    CEC opcode name (without CEC_OPCODE_ prefix) or numeric value
             Examples: "STANDBY", "0x36", "54"
  initiator  Source device

CHILD ELEMENTS:
  <stopmenu>     Stop the named menu's still picture player
  <execmenu>     Execute the named menu entry
  <commandlist>  Execute a command list

-------------------------------------------------------------------------------
5.6 Command Lists
-------------------------------------------------------------------------------

Command lists are used in <onstart>, <onstop>, <onpoweron>, etc.

Available commands:

    <poweron>device</poweron>       Power on the device
    <poweroff>device</poweroff>     Power off / standby the device
    <textviewon>device</textviewon> Send TextViewOn (wake + switch input)
    <makeactive/>                   Make VDR the active source
    <makeinactive/>                 Release active source
    <exec>command</exec>            Execute shell command

EXAMPLE:

    <onstart>
        <poweron>TV</poweron>
        <textviewon>TV</textviewon>
        <makeactive/>
        <exec>/usr/local/bin/notify-started.sh</exec>
    </onstart>

================================================================================
                          6. SVDRP COMMANDS
================================================================================

Query and control the plugin via SVDRP:

    svdrpsend plug cecremote <COMMAND>

COMMANDS:

  LSTD         List active CEC devices
  LSTK         List all supported CEC key codes
  KEYM         List available key maps
  VDRK <id>    Display VDR->CEC key map
  CECK <id>    Display CEC->VDR key map
  GLOK <id>    Display Global VDR->CEC key map
  CONN         Connect to CEC adapter
  DISC         Disconnect from CEC adapter (for other apps to use it)
  STAT         Show plugin status

================================================================================
                       7. COMMAND LINE ARGUMENTS
================================================================================

    vdr -P "cecremote [OPTIONS]"

OPTIONS:

  -c, --configdir <dir>
      Configuration directory. Relative paths are relative to VDR config dir.
      Default: cecremote

  -x, --configfile <file>
      Configuration file name.
      Default: cecremote.xml

  -l, --loglevel <level>
      Plugin log level:
        0 = none
        1 = errors only
        2 = errors + warnings
        3 = errors + warnings + debug
      Default: VDR's log level

EXAMPLE:

    vdr -P "cecremote -c /etc/vdr/cec -x myconfig.xml -l 2"

================================================================================
                          8. TROUBLESHOOTING
================================================================================

ADAPTER NOT FOUND
  - Check USB connection
  - Verify with: ls -l /dev/ttyACM*
  - Check dmesg for USB device detection

PERMISSION DENIED
  - Add user to dialout group: sudo usermod -a -G dialout $USER
  - Install udev rules from contrib/20-libcec.rules

MODEMMANAGER INTERFERENCE
  - Install the udev rule to blacklist the adapter
  - Check logs: grep -i "modem\|mtp" /var/log/syslog

NO CEC DEVICES FOUND
  - Ensure TV supports CEC (often called Anynet+, Bravia Sync, SimpLink, etc.)
  - Enable CEC in TV settings
  - Try different HDMI port
  - Test with: echo "scan" | cec-client -s -d 1

KEYS NOT WORKING
  - Check key mappings: svdrpsend plug cecremote LSTK
  - Verify with verbose logging: vdr -P "cecremote -l 3"

CRASH ON STARTUP (Raspberry Pi)
  - Use only one <cecdevicetype> in configuration

================================================================================
                             9. EXAMPLES
================================================================================

See contrib/cecremote.xml for a complete example configuration.

MINIMAL CONFIGURATION:

    <?xml version="1.0" encoding="UTF-8"?>
    <config>
        <global>
            <hdmiport>1</hdmiport>
            <onstart>
                <poweron>TV</poweron>
                <makeactive/>
            </onstart>
            <onstop>
                <makeinactive/>
            </onstop>
        </global>
    </config>

POWER SYNC WITH TV:

    <?xml version="1.0" encoding="UTF-8"?>
    <config>
        <global>
            <hdmiport>1</hdmiport>
            <shutdownonstandby>true</shutdownonstandby>
            <onstart>
                <poweron>TV</poweron>
                <makeactive/>
            </onstart>
            <onstop>
                <poweroff>TV</poweroff>
            </onstop>
        </global>
        <onceccommand command="STANDBY" initiator="TV">
            <commandlist>
                <exec>poweroff</exec>
            </commandlist>
        </onceccommand>
    </config>

================================================================================
